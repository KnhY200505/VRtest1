<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>固定模型 + 音频控制 + 实时摄像头背景</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      .btn-container {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 2;
      }
      button {
        margin: 4px;
        padding: 6px 12px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <!-- 音频选择按钮 -->
    <div class="btn-container">
      <button onclick="playAudio('AnotherDayOfSun.MP3')">Audio 1</button>
      <button onclick="playAudio('AnotherDayOfSun2.MP3')">Audio 2</button>
      <button onclick="playAudio('AnotherDayOfSun3.MP3')">Audio 3</button>
    </div>

    <!-- 摄像头视频流 -->
    <video id="cam" autoplay muted playsinline style="display: none;"></video>

    <!-- A-Frame 场景 -->
    <a-scene>
      <!-- 实时摄像头背景贴图 -->
      <a-plane id="video-plane" position="0 1.5 -4" width="8" height="4.5"></a-plane>

      <!-- 相机（包含固定的模型） -->
      <a-entity id="camera" camera look-controls position="0 1.6 0">
        <!-- 模型：始终在视野中央 -->
        <a-entity id="blendshape-model"
                  gltf-model="Cube_Blendshape_test.glb"
                  position="0 0 -1.5"
                  scale="0.2 0.2 0.2">
        </a-entity>
      </a-entity>
    </a-scene>

    <script>
      const video = document.getElementById('cam');
      let videoTexture, modelMesh;
      let audioContext, audioSource, analyser, dataArray, currentAudio;

      // 摄像头流 → video element → video texture
      navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        video.srcObject = stream;
        video.play();

        videoTexture = new THREE.VideoTexture(video);
        videoTexture.minFilter = THREE.LinearFilter;
        videoTexture.magFilter = THREE.LinearFilter;
        videoTexture.format = THREE.RGBFormat;

        const plane = document.querySelector('#video-plane');
        const mesh = plane.getObject3D('mesh');

        if (mesh) {
          mesh.material = new THREE.MeshBasicMaterial({ map: videoTexture });
        } else {
          plane.addEventListener('model-loaded', () => {
            plane.getObject3D('mesh').material = new THREE.MeshBasicMaterial({ map: videoTexture });
          });
        }
      }).catch(err => {
        alert('摄像头启动失败: ' + err);
      });

      // 获取模型 mesh → 控制 blendshape
      const modelEntity = document.querySelector('#blendshape-model');
      modelEntity.addEventListener('model-loaded', () => {
        const mesh = modelEntity.getObject3D('mesh');
        mesh.traverse(node => {
          if (node.isMesh && node.morphTargetInfluences) {
            modelMesh = node;
          }
        });
      });

      function playAudio(filename) {
        if (currentAudio) {
          currentAudio.pause();
          currentAudio = null;
        }
        if (audioContext) {
          audioContext.close();
        }

        currentAudio = new Audio(filename);
        currentAudio.loop = true;
        currentAudio.autoplay = true;

        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        audioSource = audioContext.createMediaElementSource(currentAudio);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 64;
        dataArray = new Uint8Array(analyser.frequencyBinCount);

        audioSource.connect(analyser);
        analyser.connect(audioContext.destination);

        currentAudio.play();
        audioContext.resume();
        animate();
      }

      function animate() {
        if (!analyser) return;
        requestAnimationFrame(animate);

        analyser.getByteFrequencyData(dataArray);
        const avgFreq = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
        const influence = Math.min(avgFreq / 100, 1);

        if (modelMesh && modelMesh.morphTargetInfluences) {
          modelMesh.morphTargetInfluences[0] = influence;
        }
      }
    </script>
  </body>
</html>